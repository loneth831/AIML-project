<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applications Dashboard - HR/Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .job-card {
            transition: transform 0.2s;
            border-left: 4px solid #6c5ce7;
            margin-bottom: 15px;
        }
        .job-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .interview-item {
            border-left: 4px solid #20bf6b;
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .interview-time {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people"></i> Applications Dashboard</h2>
        <div>
            <span class="badge bg-primary p-2" th:text="${#maps.size(jobWiseCounts)} + ' Active Jobs'"></span>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Quick Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <i class="bi bi-envelope fs-1"></i>
                <div class="stats-number" th:text="${#aggregates.sum(jobWiseCounts.values())}">0</div>
                <div>Total Applications</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #ffc107, #ffdb58);">
                <i class="bi bi-clock fs-1"></i>
                <div class="stats-number" id="pendingCount">0</div>
                <div>Pending Review</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8, #54d1ed);">
                <i class="bi bi-star fs-1"></i>
                <div class="stats-number" id="shortlistedCount">0</div>
                <div>Shortlisted</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #28a745, #7cd17c);">
                <i class="bi bi-calendar-check fs-1"></i>
                <div class="stats-number" th:text="${upcomingInterviews.size()}">0</div>
                <div>Upcoming Interviews</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Job-wise Application Counts -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-briefcase"></i> Applications by Job</h5>
                </div>
                <div class="card-body">
                    <div th:if="${jobWiseCounts.isEmpty()}" class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="mt-3">No applications yet</p>
                    </div>
                    <div th:unless="${jobWiseCounts.isEmpty()}" class="list-group">
                        <div th:each="entry : ${jobWiseCounts}"
                             class="list-group-item d-flex justify-content-between align-items-center job-card">
                            <div>
                                <strong th:text="${entry.key}">Software Engineer</strong>
                                <br>
                                <small class="text-muted">Click to view applications</small>
                            </div>
                            <div>
                                <span class="badge bg-primary rounded-pill fs-6 me-3"
                                      th:text="${entry.value}">15</span>
                                <a th:href="@{/applications/job/{id}(id=${#strings.substringAfter(entry.key, 'ID: ')})}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="/jobs/create" class="btn btn-outline-primary w-100 mb-2">
                                <i class="bi bi-plus-circle"></i> Post New Job
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/hr/candidates" class="btn btn-outline-success w-100 mb-2">
                                <i class="bi bi-people"></i> View Candidates
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-warning w-100 mb-2" onclick="archiveOld()">
                                <i class="bi bi-archive"></i> Archive Old
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="/skill-match/dashboard" class="btn btn-outline-info w-100 mb-2">
                                <i class="bi bi-graph-up"></i> Match Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Upcoming Interviews -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Upcoming Interviews</h5>
                    <span class="badge bg-light text-dark" th:text="${upcomingInterviews.size()}">0</span>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div th:if="${upcomingInterviews.isEmpty()}" class="text-center py-4">
                        <i class="bi bi-calendar-x display-4 text-muted"></i>
                        <p class="mt-3">No upcoming interviews scheduled</p>
                    </div>
                    <div th:unless="${upcomingInterviews.isEmpty()}" th:each="interview : ${upcomingInterviews}">
                        <div class="interview-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong th:text="${interview.candidate.fullName}">John Doe</strong>
                                    <span class="badge bg-success ms-2" th:text="${interview.job.title}">Software Engineer</span>
                                </div>
                                <span class="badge" th:classappend="${interview.interviewType == 'ONLINE'} ? 'bg-info' :
                                                                   (${interview.interviewType == 'PHONE'} ? 'bg-warning' : 'bg-secondary')"
                                      th:text="${interview.interviewType}">ONLINE</span>
                            </div>
                            <div class="interview-time mt-2">
                                <i class="bi bi-clock"></i>
                                <span th:text="${#temporals.format(interview.interviewDate, 'dd MMM yyyy HH:mm')}"></span>
                            </div>
                            <div class="mt-2">
                                <span th:if="${interview.interviewLocation}" class="text-muted me-3">
                                    <i class="bi bi-geo-alt"></i> <span th:text="${interview.interviewLocation}"></span>
                                </span>
                                <span th:if="${interview.interviewLink}" class="text-muted">
                                    <i class="bi bi-link"></i>
                                    <a th:href="${interview.interviewLink}" target="_blank">Meeting Link</a>
                                </span>
                            </div>
                            <div class="mt-2 text-end">
                                <a th:href="@{/applications/{id}(id=${interview.id})}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Distribution Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Application Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Fetch and display status distribution
    fetch('/applications/api/statistics/job/0')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Shortlisted', 'Interview', 'Rejected', 'Hired'],
                    datasets: [{
                        data: [
                            data.statusCounts?.PENDING || 0,
                            data.statusCounts?.SHORTLISTED || 0,
                            data.statusCounts?.INTERVIEW_SCHEDULED || 0,
                            data.statusCounts?.REJECTED || 0,
                            data.statusCounts?.HIRED || 0
                        ],
                        backgroundColor: [
                            '#ffc107',
                            '#17a2b8',
                            '#007bff',
                            '#dc3545',
                            '#28a745'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Update stats numbers
            document.getElementById('pendingCount').textContent = data.statusCounts?.PENDING || 0;
            document.getElementById('shortlistedCount').textContent = data.statusCounts?.SHORTLISTED || 0;
        });

    function archiveOld() {
        const days = prompt('Archive applications older than how many days?', '30');
        if (days) {
            fetch('/applications/api/archive/' + days, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
                }
            }).then(response => {
                if (response.ok) {
                    alert('Old applications archived successfully');
                    window.location.reload();
                }
            });
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>