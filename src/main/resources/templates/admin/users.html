<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people"></i> Manage Users</h2>
        <a th:href="@{/admin/users/new}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New User
        </a>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Filter by Role</label>
                    <select name="role" class="form-select" onchange="this.form.submit()">
                        <option value="">All Roles</option>
                        <option value="CANDIDATE" th:selected="${selectedRole == 'CANDIDATE'}">Candidates</option>
                        <option value="HR" th:selected="${selectedRole == 'HR'}">HR Users</option>
                        <option value="ADMIN" th:selected="${selectedRole == 'ADMIN'}">Admins</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Search Users</label>
                    <div class="input-group">
                        <input type="text" name="search" class="form-control"
                               th:value="${search}" placeholder="Search by name, email, or skills">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <a th:href="@{/admin/users}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Skills</th>
                        <th>AI Status</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user : ${users}"
                        th:class="${user.currentResume != null and user.currentResume.mlProcessed} ? 'ml-processed' : ''">
                        <td th:text="${user.id}">1</td>
                        <td>
                            <strong th:text="${user.firstName + ' ' + user.lastName}">John Doe</strong><br>
                            <small class="text-muted" th:text="${user.username}">@username</small>
                        </td>
                        <td th:text="${user.email}">email@example.com</td>
                        <td>
                            <form th:action="@{/admin/users/{id}/role(id=${user.id})}" method="post" class="d-inline">
                                <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="CANDIDATE" th:selected="${user.role.name() == 'CANDIDATE'}">Candidate</option>
                                    <option value="HR" th:selected="${user.role.name() == 'HR'}">HR</option>
                                    <option value="ADMIN" th:selected="${user.role.name() == 'ADMIN'}">Admin</option>
                                </select>
                            </form>
                        </td>
                        <td>
                            <span th:if="${user.skills}" th:text="${#strings.abbreviate(user.skills, 30)}">Skills</span>
                            <span th:unless="${user.skills}" class="text-muted">-</span>
                        </td>
                        <td>
    <span th:if="${user.currentResume != null and user.currentResume.mlProcessed}" class="badge bg-success">
        <i class="bi bi-check-circle"></i> Processed
        <span th:if="${user.currentResume.mlScore}"
              th:text="'(' + ${#numbers.formatDecimal(user.currentResume.mlScore, 1, 1)} + ')'"></span>
    </span>
                            <span th:unless="${user.currentResume != null and user.currentResume.mlProcessed}" class="badge bg-warning">
        <i class="bi bi-clock"></i> Pending
    </span>
                        </td>
                        <td>
                            <span th:if="${user.active}" class="badge bg-success">Active</span>
                            <span th:unless="${user.active}" class="badge bg-danger">Inactive</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{/admin/users/{id}/edit(id=${user.id})}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>

                                <!-- Deactivate Button -->
                                <button th:if="${user.active}"
                                        class="btn btn-sm btn-outline-warning action-deactivate"
                                        th:data-id="${user.id}">
                                    <i class="bi bi-pause"></i>
                                </button>

                                <!-- Activate Button -->
                                <button th:unless="${user.active}"
                                        class="btn btn-sm btn-outline-success action-activate"
                                        th:data-id="${user.id}">
                                    <i class="bi bi-play"></i>
                                </button>

                                <!-- Delete Button -->
                                <button class="btn btn-sm btn-outline-danger action-delete"
                                        th:data-id="${user.id}"
                                        th:data-name="${user.fullName}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a th:href="@{/admin/dashboard}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin users page loaded');

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');

        // Function to send POST request
        function sendPostRequest(url, csrfToken, csrfHeader) {
            console.log('Sending POST request to:', url);

            let headers = {
                'Content-Type': 'application/x-www-form-urlencoded'
            };

            // Add CSRF token to headers if available
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch(url, {
                method: 'POST',
                headers: headers,
                credentials: 'same-origin'  // Include cookies
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (response.redirected) {
                        console.log('Redirecting to:', response.url);
                        window.location.href = response.url;
                    } else {
                        return response.text().then(text => {
                            console.log('Response text:', text);
                            if (response.ok) {
                                // If successful but no redirect, reload the page
                                window.location.reload();
                            } else {
                                alert('Error: ' + (text || 'Unknown error occurred'));
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('An error occurred: ' + error.message);
                });
        }

        // Handle deactivate buttons
        document.querySelectorAll('.action-deactivate').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.getAttribute('data-id');
                console.log('Deactivate clicked for user:', userId);
                if (confirm('Are you sure you want to deactivate this user?')) {
                    sendPostRequest('/admin/users/' + userId + '/deactivate', csrfToken, csrfHeader);
                }
            });
        });

        // Handle activate buttons
        document.querySelectorAll('.action-activate').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.getAttribute('data-id');
                console.log('Activate clicked for user:', userId);
                if (confirm('Are you sure you want to activate this user?')) {
                    sendPostRequest('/admin/users/' + userId + '/activate', csrfToken, csrfHeader);
                }
            });
        });

        // Handle delete buttons
        document.querySelectorAll('.action-delete').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.getAttribute('data-id');
                const userName = this.getAttribute('data-name');
                console.log('Delete clicked for user:', userId, userName);
                if (confirm('Are you sure you want to delete user: ' + userName + '?\nThis action cannot be undone!')) {
                    sendPostRequest('/admin/users/' + userId + '/delete', csrfToken, csrfHeader);
                }
            });
        });

        // Handle role change forms
        document.querySelectorAll('form[action*="/role"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                // Let the form submit normally - no need to prevent default
                console.log('Role change form submitted');
            });
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>