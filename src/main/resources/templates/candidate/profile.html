<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Candidate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .profile-card {
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 10px 10px;
        }
        .nav-tabs .nav-link.active {
            background-color: #6c5ce7;
            color: white;
            border-color: #6c5ce7;
        }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <!-- Success/Error Messages -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card profile-card">
        <!-- Profile Header -->
        <div class="profile-header p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-person-circle"></i> My Profile</h2>
                    <p class="mb-0">Manage your personal and professional information</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-light text-dark" style="font-size: 1rem;">
                        <i class="bi bi-shield-check"></i> Candidate Account
                    </span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="profileTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab"
                        data-bs-target="#personal" type="button" role="tab">
                    <i class="bi bi-person"></i> Personal Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="professional-tab" data-bs-toggle="tab"
                        data-bs-target="#professional" type="button" role="tab">
                    <i class="bi bi-briefcase"></i> Professional Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                        data-bs-target="#security" type="button" role="tab">
                    <i class="bi bi-shield-lock"></i> Security
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="account-tab" data-bs-toggle="tab"
                        data-bs-target="#account" type="button" role="tab">
                    <i class="bi bi-gear"></i> Account Settings
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="profileTabContent">
            <!-- Personal Information Tab -->
            <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <!-- Personal Information Tab -->
                <form th:action="@{/candidate/profile/update/personal}" method="post">
                    <h4 class="mb-4"><i class="bi bi-person-vcard"></i> Personal Information</h4>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" name="firstName"
                                   th:value="${user.firstName}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" name="lastName"
                                   th:value="${user.lastName}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email"
                                   th:value="${user.email}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="phone"
                                   th:value="${user.phone}" placeholder="Enter your phone number">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Update Personal Info
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Professional Information Tab -->
            <div class="tab-pane fade" id="professional" role="tabpanel">
                <!-- Professional Information Tab -->
                <form th:action="@{/candidate/profile/update/professional}" method="post">
                    <h4 class="mb-4"><i class="bi bi-briefcase"></i> Professional Information</h4>

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Skills *</label>
                            <textarea class="form-control" name="skills" rows="3"
                                      th:text="${user.skills}"
                                      placeholder="Enter your skills separated by commas (e.g., Java, Spring Boot, SQL)"
                                      required></textarea>
                            <small class="form-text text-muted">These skills will be used for AI matching</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Years of Experience</label>
                            <input type="number" class="form-control" name="experienceYears"
                                   th:value="${user.experienceYears}" min="0" max="50" step="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Highest Education</label>
                            <input type="text" class="form-control" name="education"
                                   th:value="${user.education}"
                                   placeholder="e.g., B.Sc Computer Science">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Update Professional Info
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel">
                <h4 class="mb-4"><i class="bi bi-shield-lock"></i> Change Password</h4>

                <form th:action="@{/candidate/change-password}" method="post" id="passwordForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Current Password *</label>
                            <input type="password" class="form-control" name="currentPassword" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">New Password *</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" id="passwordStrength"></div>
                            </div>
                            <small class="form-text" id="passwordFeedback"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirm New Password *</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <small class="form-text" id="passwordMatch"></small>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                <i class="bi bi-key"></i> Change Password
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Account Settings Tab -->
            <div class="tab-pane fade" id="account" role="tabpanel">
                <h4 class="mb-4"><i class="bi bi-gear"></i> Account Settings</h4>

                <!-- Account Status -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5><i class="bi bi-person-check"></i> Account Status</h5>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span th:if="${user.active}" class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Active
                                </span>
                                <span th:unless="${user.active}" class="badge bg-danger">
                                    <i class="bi bi-x-circle"></i> Inactive
                                </span>
                                <p class="mt-2 mb-0">
                                    Account created: <span th:text="${#temporals.format(user.createdAt, 'dd MMMM yyyy')}"></span>
                                </p>
                            </div>
                            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                <i class="bi bi-trash"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Status -->
                <div class="card">
                    <div class="card-body">
                        <h5><i class="bi bi-cpu"></i> AI Analysis Status</h5>
                        <div th:if="${user.currentResume != null and user.currentResume.mlProcessed}">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> Your profile has been analyzed by AI
                            </div>
                            <p><strong>AI Score:</strong>
                                <span th:text="${#numbers.formatDecimal(user.currentResume.mlScore, 1, 1)}"></span>
                            </p>
                            <p><strong>Confidence:</strong>
                                <span th:text="${#numbers.formatDecimal(user.currentResume.mlConfidence, 1, 1)}"></span>%
                            </p>
                            <a th:href="@{/candidate/ai-analysis}" class="btn btn-outline-primary">
                                <i class="bi bi-graph-up"></i> View AI Analysis
                            </a>
                        </div>
                        <div th:if="${user.currentResume == null or !user.currentResume.mlProcessed}">
                            <div class="alert alert-warning">
                                <i class="bi bi-clock"></i> Your profile hasn't been analyzed by AI yet
                            </div>
                            <p>Complete your profile and upload your resume to get AI analysis.</p>
                            <a th:href="@{/candidate/resume/upload}" class="btn btn-primary">
                                <i class="bi bi-upload"></i> Upload Resume
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mt-3">
        <a th:href="@{/candidate/dashboard}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-octagon"></i> Warning: This action cannot be undone!</h6>
                    <p class="mb-0">All your data, including profile information and resume, will be permanently deleted.</p>
                </div>
                <p>If you're sure you want to proceed, please confirm by entering your password below.</p>
                <form th:action="@{/candidate/delete-account}" method="post">
                    <div class="mb-3">
                        <label class="form-label">Enter your password to confirm:</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Delete My Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Password strength checker
    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const strengthBar = document.getElementById('passwordStrength');
        const feedback = document.getElementById('passwordFeedback');

        let strength = 0;
        let feedbackText = '';

        if (password.length >= 8) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 25;
        if (/[^A-Za-z0-9]/.test(password)) strength += 25;

        strengthBar.style.width = strength + '%';

        if (strength < 50) {
            strengthBar.className = 'progress-bar bg-danger';
            feedbackText = 'Weak password';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-warning';
            feedbackText = 'Moderate password';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            feedbackText = 'Strong password';
        }

        feedback.textContent = feedbackText;
    }

    // Password match checker
    function checkPasswordMatch() {
        const password = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        const matchText = document.getElementById('passwordMatch');
        const submitBtn = document.getElementById('changePasswordBtn');

        if (confirm.length === 0) {
            matchText.textContent = '';
            submitBtn.disabled = true;
            return;
        }

        if (password === confirm) {
            matchText.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Passwords match</span>';
            submitBtn.disabled = false;
        } else {
            matchText.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Passwords do not match</span>';
            submitBtn.disabled = true;
        }
    }

    // Initialize password checking
    document.getElementById('newPassword').addEventListener('keyup', checkPasswordStrength);
    document.getElementById('confirmPassword').addEventListener('keyup', checkPasswordMatch);

    // Initialize tabs
    document.addEventListener('DOMContentLoaded', function() {
        var triggerTabList = [].slice.call(document.querySelectorAll('#profileTab button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        });

        // Initialize password form
        checkPasswordMatch();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>